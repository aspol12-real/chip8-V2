#pragma once

#include <cstdint>
#include <iostream>
#include <vector>
#include <fstream>
#include <cstdlib>

#include "graphics.hpp"

const int MEM_SIZE = 65535;
const int STACK_SIZE = 16;

class cpu {
    private:


        uint8_t mem[MEM_SIZE]; //65kb memory space (XO-CHIP spec)
        uint16_t stack[STACK_SIZE];
        uint8_t v[16]; //16 8-bit registers v0-vF
        uint8_t flags_storage[16];

        uint16_t pc; //16-bit program counter
        uint16_t sp; //16-bit stack pointer
        uint16_t I;  //16-bit memory pointer


        uint8_t font_data[240] = {
        
            // regular characters 0-F

            0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
            0x20, 0x60, 0x20, 0x20, 0x70, // 1
            0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
            0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
            0x90, 0x90, 0xF0, 0x10, 0x10, // 4
            0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
            0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
            0xF0, 0x10, 0x20, 0x40, 0x40, // 7
            0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
            0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
            0xF0, 0x90, 0xF0, 0x90, 0x90, // A
            0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
            0xF0, 0x80, 0x80, 0x80, 0xF0, // C
            0xE0, 0x90, 0x90, 0x90, 0xE0, // D
            0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
            0xF0, 0x80, 0xF0, 0x80, 0x80, // F
                                          
            //BIG HEX 0-F

            0x3C, 0x7E, 0xE7, 0xC3, 0xC3, 0xC3, 0xC3, 0xE7, 0x7E, 0x3C, //0
            0x30, 0x70, 0xB0, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, //1
            0x3E, 0x7F, 0xC3, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xFF, 0xFF, //2
            0x3C, 0x7E, 0xC3, 0x03, 0x0E, 0x0E, 0x03, 0xC3, 0x7E, 0x3C, //3
            0x06, 0x0E, 0x1E, 0x36, 0x66, 0xC6, 0xFF, 0xFF, 0x06, 0x06, //4
            0xFF, 0xFF, 0xC0, 0xC0, 0xFC, 0xFE, 0x03, 0xC3, 0x7E, 0x3C, //5
            0x3E, 0x7C, 0xE0, 0xC0, 0xFC, 0xFE, 0xC3, 0xC3, 0x7E, 0x3C, //6
            0xFF, 0xFF, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x60, 0x60, //7
            0x3C, 0x7E, 0xC3, 0xC3, 0x7E, 0x7E, 0xC3, 0xC3, 0x7E, 0x3C, //8
            0x3C, 0x7E, 0xC3, 0xC3, 0x7F, 0x3F, 0x03, 0x03, 0x3E, 0x7C, //9
            0x7E, 0xFF, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xC3, //A
            0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, //B
            0x3C, 0xFF, 0xC3, 0xC0, 0xC0, 0xC0, 0xC0, 0xC3, 0xFF, 0x3C, //C
            0xFC, 0xFE, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFE, 0xFC, //D
            0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, //E
            0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, //F
        };

        //opcode methods

        void call(uint16_t nnn);
        void ret();
        void jeq(uint8_t a, uint8_t b);
        void jneq(uint8_t a, uint8_t b);
        void reg_to_mem(uint8_t x, uint8_t y);
        void reg_from_mem(uint8_t x, uint8_t y);
        void reg_to_flags(uint8_t x, uint8_t y);
        void reg_from_flags(uint8_t x, uint8_t y);
        void add(uint8_t x, uint8_t y);
        void sub_xy(uint8_t x, uint8_t y);
        void sub_yx(uint8_t x, uint8_t y);
        void shift_left(uint8_t x, uint8_t y);
        void shift_right(uint8_t x, uint8_t y);
        void gen_rand(uint8_t nn, uint8_t x, uint8_t random);
        void word_index();
        void small_hex(uint8_t x);
        void big_hex(uint8_t x);
        void big_skip_check();
        void BCD(uint8_t x);
        void wait(uint8_t x);


    public:

        graphics scr;

        cpu() : scr(mem) {}

        uint8_t sound; //8-bit sound timer
        uint8_t delay; //8-bit delay timer

        bool keys[16];

        void init();
        void execute();
        void load_rom(std::string rom);
        void tick_timers();
        
};
